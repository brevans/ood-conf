---
- hosts: all
  tasks:
    - name: "Make sure directories exist"
      file:
        path: /{{ item.path }}
        state: directory
        mode: 0775
      with_filetree: ood_root/
      when: item.state == "directory"

    - name: OOD configuration files
      template:
        src: "{{ item.src }}"
        dest: /etc/{{ item.path | regex_replace('\.j2$','') }}
        mode: "{{ item.mode }}"
      with_filetree: ood_root/etc/
      when: item.state == "file"

    - name: "Rename Cluster yml"
      command: |
        mv /etc/ood/config/clusters.d/Cluster.yml \
           /etc/ood/config/clusters.d/{{ inventory_hostname|title  }}.yml

    - name: "Enable CAS Auth module"
      lineinfile:
        dest: /opt/rh/httpd24/root/etc/httpd/conf.modules.d/yalehpc-cas.conf
        line: "LoadModule auth_cas_module modules/mod_auth_cas.so"
        state: present
        create: yes
        mode: 0644

    - name: "Dashboard shell tweak"
      template:
        src: "ood_root/var/www/ood/apps/sys/shell/manifest.yml.j2"
        dest: "/var/www/ood/apps/sys/shell/manifest.yml"

    - name: "Dashboard Branding"
      copy:
        src: "{{ item }}"
        dest: "/var/www/ood/public/"
      with_fileglob: 
         - "ood_root/var/www/ood/public/*"

    - name: "Deploy OOD Apache config"
      command: "/opt/ood/ood-portal-generator/sbin/update_ood_portal"
      register: update_ood_portal_out
      failed_when: update_ood_portal_out.rc > 1 

    - name: "Restart httpd"
      when: update_ood_portal_out.rc == 0
      systemd:
        name: "{{ item }}"
        state: reloaded
      with_items:
        - "httpd24-httpd"
        - "httpd24-htcacheclean"
